version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: moneymind-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: moneymind
      POSTGRES_USER: moneymind_user
      POSTGRES_PASSWORD: moneymind_secure_password_2024
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U moneymind_user -d moneymind"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache & Pub/Sub
  redis:
    image: redis:7-alpine
    container_name: moneymind-redis
    restart: unless-stopped
    command: redis-server --requirepass moneymind_redis_password_2024 --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "moneymind_redis_password_2024", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: moneymind-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: moneymind_user
      RABBITMQ_DEFAULT_PASS: moneymind_rabbitmq_password_2024
    ports:
      - "5673:5672"   # AMQP
      - "15673:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: moneymind-qdrant
    restart: unless-stopped
    ports:
      - "6344:6333"
      - "6345:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Graph Database
  neo4j:
    image: neo4j:5-community
    container_name: moneymind-neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: neo4j/moneymind_neo4j_password_2024
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 512m
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
      NEO4J_dbms_security_procedures_allowlist: apoc.*,gds.*
    ports:
      - "7484:7474"  # HTTP
      - "7697:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Ollama LLM Server - DISABLED: Using host Ollama at localhost:11434
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: moneymind-ollama
  #   restart: unless-stopped
  #   ports:
  #     - "11444:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   networks:
  #     - moneymind-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   # GPU support for NVIDIA 1050ti
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 1
  #             capabilities: [gpu]

  # Sandbox MCP for secure code execution
  # Built from https://github.com/pottekkat/sandbox-mcp
  sandbox:
    build:
      context: ./sandbox
      dockerfile: Dockerfile
    container_name: moneymind-sandbox
    restart: unless-stopped
    privileged: true  # Required for Docker-in-Docker
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Share host Docker socket
      - sandbox_data:/root/.config/sandbox-mcp
    ports:
      - "8011:8001"
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: moneymind-backend
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Database Connections
      DATABASE_URL: postgresql+asyncpg://moneymind_user:moneymind_secure_password_2024@postgres:5432/moneymind
      REDIS_URL: redis://:moneymind_redis_password_2024@redis:6379/0
      RABBITMQ_URL: amqp://moneymind_user:moneymind_rabbitmq_password_2024@rabbitmq:5672//
      QDRANT_URL: http://qdrant:6333
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: moneymind_neo4j_password_2024
      
      # Application Settings
      APP_ENV: production
      DEBUG: "false"
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      JWT_SECRET: ${JWT_SECRET:-change-this-jwt-secret-in-production}
      ALLOWED_ORIGINS: http://192.168.0.109:3010,http://localhost:3010,http://frontend:3000
      
      # LLM Settings
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_MODEL: phi4-mini
      HUGGINGFACE_API_TOKEN: ${HUGGINGFACE_API_TOKEN:-}
      HUGGINGFACE_MODEL: mistralai/Mistral-7B-Instruct-v0.2
      
      # External APIs
      EXCHANGE_RATE_API_KEY: ${EXCHANGE_RATE_API_KEY:-}
      ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY:-}
      
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: http://localhost:8010/api/auth/google/callback
      
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      
      # Sandbox
      SANDBOX_MCP_URL: http://sandbox:8001
    ports:
      - "8010:8000"
    volumes:
      - ./backend:/app  # Mount source code for live reload
      - backend_uploads:/app/uploads
      - backend_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery Worker for Background Tasks
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: moneymind-celery-worker
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: celery -A src.infrastructure.queue.celery_app worker --loglevel=info --concurrency=4
    environment:
      DATABASE_URL: postgresql+asyncpg://moneymind_user:moneymind_secure_password_2024@postgres:5432/moneymind
      REDIS_URL: redis://:moneymind_redis_password_2024@redis:6379/0
      RABBITMQ_URL: amqp://moneymind_user:moneymind_rabbitmq_password_2024@rabbitmq:5672//
      QDRANT_URL: http://qdrant:6333
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: moneymind_neo4j_password_2024
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      HUGGINGFACE_API_TOKEN: ${HUGGINGFACE_API_TOKEN:-}
      ALLOWED_ORIGINS: http://192.168.0.109:3010,http://localhost:3010,http://frontend:3000
    volumes:
      - backend_uploads:/app/uploads
    depends_on:
      - backend
      - rabbitmq
      - redis
    networks:
      - moneymind-network

  # Celery Beat for Scheduled Tasks
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: moneymind-celery-beat
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: celery -A src.infrastructure.queue.celery_app beat --loglevel=info
    environment:
      DATABASE_URL: postgresql+asyncpg://moneymind_user:moneymind_secure_password_2024@postgres:5432/moneymind
      REDIS_URL: redis://:moneymind_redis_password_2024@redis:6379/0
      RABBITMQ_URL: amqp://moneymind_user:moneymind_rabbitmq_password_2024@rabbitmq:5672//
      ALLOWED_ORIGINS: http://192.168.0.109:3010,http://localhost:3010,http://frontend:3000
    volumes:
      - celery_beat_data:/app/data
    depends_on:
      - celery-worker
    networks:
      - moneymind-network

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://192.168.0.109:8010
        NEXT_PUBLIC_WS_URL: ws://192.168.0.109:8010
    container_name: moneymind-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: http://192.168.0.109:8010
      NEXT_PUBLIC_WS_URL: ws://192.168.0.109:8010
      NODE_ENV: production
    ports:
      - "3010:3000"
    depends_on:
      - backend
    networks:
      - moneymind-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  moneymind-network:
    driver: bridge
    name: moneymind-network

volumes:
  postgres_data:
    name: moneymind-postgres-data
  redis_data:
    name: moneymind-redis-data
  rabbitmq_data:
    name: moneymind-rabbitmq-data
  qdrant_data:
    name: moneymind-qdrant-data
  neo4j_data:
    name: moneymind-neo4j-data
  neo4j_logs:
    name: moneymind-neo4j-logs
  neo4j_import:
    name: moneymind-neo4j-import
  neo4j_plugins:
    name: moneymind-neo4j-plugins
  ollama_data:
    name: moneymind-ollama-data
  backend_uploads:
    name: moneymind-backend-uploads
  backend_logs:
    name: moneymind-backend-logs
  celery_beat_data:
    name: moneymind-celery-beat-data
  sandbox_data:
    name: moneymind-sandbox-data
